<html><head><base href="https://example.com/">
  <meta charset="UTF-8">
  <title>Interactive Art Gallery</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: "Helvetica Neue", Arial, sans-serif;
      background: #fff5f7;
      display: flex;
      flex-direction: column;
      align-items: center;
      min-height: 100vh;
      padding: 20px;
    }
    .gallery {
      background: white;
      padding: 20px;
      border-radius: 20px;
      box-shadow: 0 4px 15px rgba(255,182,193,0.3);
      max-width: 800px;
      width: 100%;
      border: 3px solid #ffb6c1;
    }
    .art-display {
      position: relative;
      min-height: 400px;
      border: 2px dashed #ffb6c1;
      border-radius: 15px;
      margin-bottom: 20px;
      display: flex;
      justify-content: center;
      align-items: center;
      background: #fff;
    }
    .chat-area {
      height: 200px;
      border: 2px solid #ffb6c1;
      border-radius: 15px;
      padding: 15px;
      overflow-y: auto;
      margin-bottom: 15px;
      background: #fff;
    }
    .controls {
      display: flex;
      gap: 15px;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    button {
      padding: 10px 20px;
      background: #ff9ac1;
      color: white;
      border: none;
      border-radius: 25px;
      cursor: pointer;
      font-size: 14px;
      transition: all 0.3s ease;
      box-shadow: 0 2px 5px rgba(255,154,193,0.3);
    }
    button:hover {
      background: #ff80ab;
      transform: translateY(-2px);
    }
    .message {
      margin: 8px 0;
      padding: 10px;
      border-radius: 15px;
      font-size: 14px;
    }
    .user-message {
      background: #ffe6eb;
      text-align: right;
      margin-left: 20%;
    }
    .art-message {
      background: #f8f8f8;
      margin-right: 20%;
    }
    #fileInput {
      display: none;
    }
    .participants {
      margin-bottom: 15px;
      padding: 12px;
      background: #ffe6eb;
      border-radius: 15px;
      font-size: 15px;
      color: #ff6b9c;
    }
    rt {
      font-size: 0.8em;
      color: #000;
    }
    .message-input {
      display: flex;
      gap: 10px;
      margin-top: 10px;
    }
    #messageText {
      flex: 1;
      padding: 10px;
      border: 2px solid #ffb6c1;
      border-radius: 25px;
      font-size: 14px;
      outline: none;
    }
    #messageText:focus {
      border-color: #ff80ab;
    }
    .send-button {
      padding: 10px 25px;
    }
  </style>
</head>
<body>
  <div class="gallery">
    <div class="participants">
      <ruby>å‚åŠ è€…<rt>ã•ã‚“ã‹ã—ã‚ƒ</rt></ruby>: <span id="participantCount">1</span><ruby>äºº<rt>ã«ã‚“</rt></ruby>
    </div>
    <div class="art-display" id="artDisplay">
      <svg width="400" height="300" viewBox="0 0 400 300">
        <rect width="100%" height="100%" fill="#fff5f7"/>
        <circle cx="200" cy="150" r="80" fill="#ff9ac1" opacity="0.8">
          <animate attributeName="r" values="80;85;80" dur="2s" repeatCount="indefinite"/>
        </circle>
        <path d="M180,130 Q200,110 220,130 Q200,150 180,130" fill="#ff6b9c"/>
        <circle cx="185" cy="120" r="5" fill="#fff"/>
        <circle cx="215" cy="120" r="5" fill="#fff"/>
        <text x="200" y="155" text-anchor="middle" fill="#fff" font-size="14">
          ã‚¢ãƒ¼ãƒˆã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦<ruby>ä¼šè©±<rt>ã‹ã„ã‚</rt></ruby>ã‚’<ruby>é–‹å§‹<rt>ã‹ã„ã—</rt></ruby>
        </text>
      </svg>
    </div>
    <div class="chat-area" id="chatArea"></div>
    <div class="message-input">
      <input type="text" id="messageText" placeholder="ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„">
      <button class="send-button" onclick="sendMessage()">ğŸ’¬ é€ä¿¡</button>
    </div>
    <div class="controls">
      <button onclick="document.getElementById('fileInput').click()">ğŸ–¼ï¸ <ruby>ç”»åƒ<rt>ãŒãã†</rt></ruby>ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</button>
      <button onclick="generateNewArt()">âœ¨ <ruby>æ–°<rt>ã‚ãŸã‚‰</rt></ruby>ã—ã„ã‚¢ãƒ¼ãƒˆã‚’<ruby>ç”Ÿæˆ<rt>ã›ã„ã›ã„</rt></ruby></button>
      <button onclick="toggleSpeech()">ğŸ¤ <ruby>éŸ³å£°<rt>ãŠã‚“ã›ã„</rt></ruby>ãƒãƒ£ãƒƒãƒˆ</button>
    </div>
    <input type="file" id="fileInput" accept="image/*" onchange="handleFileUpload(event)">
  </div>

  <script>
    let isListening = false;
    let recognition = null;
    let synthesis = window.speechSynthesis;
    let currentQuestionIndex = 0;
    let lastResponse = '';
    let askedQuestions = new Set();

    const initialQuestions = [
      "ã“ã®ä½œå“ã®ä¸­ã§ã€ä¸€ç•ªå°è±¡ã«æ®‹ã‚‹éƒ¨åˆ†ã¯ã©ã“ã§ã™ã‹ï¼Ÿ",
      "ã“ã®ä½œå“ã‚’è¦‹ã¦ã€ã©ã‚“ãªå­£ç¯€ã‚’æ„Ÿã˜ã¾ã™ã‹ï¼Ÿ",
      "ã“ã®ä½œå“ã‹ã‚‰ã€ã©ã‚“ãªéŸ³ãŒèã“ãˆã¦ããã†ã§ã™ã‹ï¼Ÿ",
      "ã‚‚ã—ã“ã®ä½œå“ã«é¡Œåã‚’ã¤ã‘ã‚‹ã¨ã—ãŸã‚‰ã€ä½•ã«ã—ã¾ã™ã‹ï¼Ÿ",
      "ã“ã®ä½œå“ã®ä¸­ã«ã€ã‚ãªãŸã®å¥½ããªè‰²ã¯å«ã¾ã‚Œã¦ã„ã¾ã™ã‹ï¼Ÿ",
      "ã“ã®ä½œå“ã‹ã‚‰ã€ã©ã‚“ãªåŒ‚ã„ã‚’æ„Ÿã˜ã¾ã™ã‹ï¼Ÿ",
      "ã“ã®ä½œå“ã®ä¸­ã§ã€å‹•ãã‚’æ„Ÿã˜ã‚‹éƒ¨åˆ†ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
      "ã“ã®ä½œå“ã‚’èª°ã‹ã«ãƒ—ãƒ¬ã‚¼ãƒ³ãƒˆã™ã‚‹ã¨ã—ãŸã‚‰ã€èª°ã«ã‚ã’ãŸã„ã§ã™ã‹ï¼Ÿ",
      "ã“ã®ä½œå“ã¯ã€ã©ã‚“ãªå ´æ‰€ã«é£¾ã‚‹ã®ãŒé©ã—ã¦ã„ã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
      "ã“ã®ä½œå“ã‚’è¦‹ã¦ã„ã‚‹ã¨ã€ã©ã‚“ãªæ€ã„å‡ºãŒæµ®ã‹ã³ã¾ã™ã‹ï¼Ÿ"
    ];

    const followUpQuestions = {
      0: [
        "ãã®éƒ¨åˆ†ãŒå°è±¡çš„ãªç†ç”±ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ",
        "ä»–ã®éƒ¨åˆ†ã¨æ¯”ã¹ã¦ã€ã©ã®ã‚ˆã†ãªé•ã„ãŒã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
        "ãã®éƒ¨åˆ†ã‚’è¦‹ã¦ã„ã‚‹ã¨ã€ã©ã‚“ãªæ°—æŒã¡ã«ãªã‚Šã¾ã™ã‹ï¼Ÿ"
      ],
      1: [
        "ãã®å­£ç¯€ã‚’æ„Ÿã˜ã‚‹ç†ç”±ã¯ä½•ã§ã™ã‹ï¼Ÿ",
        "ãã®å­£ç¯€ã®æ€ã„å‡ºã¨é‡ãªã‚‹éƒ¨åˆ†ã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
        "åˆ¥ã®å­£ç¯€ã ã¨ã—ãŸã‚‰ã€ã©ã‚“ãªå­£ç¯€ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã‹ï¼Ÿ"
      ],
      2: [
        "ãã®éŸ³ã¯ã€ã©ã‚“ãªæ„Ÿæƒ…ã‚’å‘¼ã³èµ·ã“ã—ã¾ã™ã‹ï¼Ÿ",
        "ãã®éŸ³ãŒèã“ãˆã¦ãã‚‹ç†ç”±ã¯ä½•ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
        "ä»–ã«ã©ã‚“ãªéŸ³ãŒé‡ãªã‚Šãã†ã§ã™ã‹ï¼Ÿ"
      ],
      3: [
        "ãã®é¡Œåã‚’ã¤ã‘ãŸç†ç”±ã‚’æ•™ãˆã¦ã„ãŸã ã‘ã¾ã™ã‹ï¼Ÿ",
        "ãã®é¡Œåã‹ã‚‰é€£æƒ³ã•ã‚Œã‚‹ç‰©èªã¯ã‚ã‚Šã¾ã™ã‹ï¼Ÿ",
        "åˆ¥ã®è¦–ç‚¹ã§è¦‹ãŸã‚‰ã€ã©ã‚“ãªé¡ŒåãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã‹ï¼Ÿ"
      ],
      4: [
        "ãã®è‰²ãŒå¥½ããªç†ç”±ã¯ä½•ã§ã™ã‹ï¼Ÿ",
        "ãã®è‰²ã¯ã€ã©ã‚“ãªæ€ã„å‡ºã¨çµã³ã¤ã„ã¦ã„ã¾ã™ã‹ï¼Ÿ",
        "ã‚‚ã—è‰²ã‚’å¤‰ãˆã‚‹ã¨ã—ãŸã‚‰ã€ã©ã‚“ãªè‰²ã‚’é¸ã³ã¾ã™ã‹ï¼Ÿ"
      ],
      5: [
        "ãã®åŒ‚ã„ã¯ã€ã©ã‚“ãªæ„Ÿæƒ…ã‚’å‘¼ã³èµ·ã“ã—ã¾ã™ã‹ï¼Ÿ",
        "ãã®åŒ‚ã„ãŒæ„Ÿã˜ã‚‰ã‚Œã‚‹ç†ç”±ã¯ä½•ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
        "ä»–ã«ã©ã‚“ãªåŒ‚ã„ãŒæƒ³åƒã•ã‚Œã¾ã™ã‹ï¼Ÿ"
      ],
      6: [
        "ãã®å‹•ãã¯ã€ã©ã‚“ãªæ„Ÿæƒ…ã‚’å‘¼ã³èµ·ã“ã—ã¾ã™ã‹ï¼Ÿ",
        "ãã®å‹•ããŒæ„Ÿã˜ã‚‰ã‚Œã‚‹ç†ç”±ã¯ä½•ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
        "ä»–ã«ã©ã‚“ãªå‹•ããŒæƒ³åƒã•ã‚Œã¾ã™ã‹ï¼Ÿ"
      ],
      7: [
        "ãã®äººã«ã‚ã’ãŸã„ç†ç”±ã¯ä½•ã§ã™ã‹ï¼Ÿ",
        "ãã®äººã«ã¨ã£ã¦ã©ã‚“ãªæ„å‘³ãŒã‚ã‚‹ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
        "ä»–ã«èª°ã«ã‚ã’ãŸã„ã§ã™ã‹ï¼Ÿ"
      ],
      8: [
        "ãã®å ´æ‰€ã«é£¾ã‚‹ç†ç”±ã¯ä½•ã§ã™ã‹ï¼Ÿ",
        "ãã®å ´æ‰€ãŒé©ã—ã¦ã„ã‚‹ç†ç”±ã¯ä½•ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
        "ä»–ã«ã©ã‚“ãªå ´æ‰€ãŒè€ƒãˆã‚‰ã‚Œã¾ã™ã‹ï¼Ÿ"
      ],
      9: [
        "ãã®æ€ã„å‡ºã¯ã€ã©ã‚“ãªæ„Ÿæƒ…ã‚’å‘¼ã³èµ·ã“ã—ã¾ã™ã‹ï¼Ÿ",
        "ãã®æ€ã„å‡ºãŒæµ®ã‹ã¶ç†ç”±ã¯ä½•ã ã¨æ€ã„ã¾ã™ã‹ï¼Ÿ",
        "ä»–ã«ã©ã‚“ãªæ€ã„å‡ºãŒæµ®ã‹ã³ã¾ã™ã‹ï¼Ÿ"
      ]
    };

    if ('webkitSpeechRecognition' in window) {
      recognition = new webkitSpeechRecognition();
      recognition.continuous = true;
      recognition.interimResults = true;
      recognition.lang = 'ja-JP';

      recognition.onresult = function(event) {
        const last = event.results.length - 1;
        const text = event.results[last][0].transcript;
        
        if (event.results[last].isFinal) {
          addMessage(text, 'user-message');
          respondToMessage(text);
        }
      };
    }

    function respondToMessage(text) {
      let response;
      if (lastResponse) {
        const followUps = followUpQuestions[currentQuestionIndex];
        const availableFollowUps = followUps.filter(q => !askedQuestions.has(q));
        if (availableFollowUps.length > 0) {
          response = availableFollowUps[Math.floor(Math.random() * availableFollowUps.length)];
        } else {
          currentQuestionIndex = (currentQuestionIndex + 1) % initialQuestions.length;
          response = initialQuestions[currentQuestionIndex];
        }
      } else {
        const availableQuestions = initialQuestions.filter(q => !askedQuestions.has(q));
        if (availableQuestions.length > 0) {
          response = availableQuestions[Math.floor(Math.random() * availableQuestions.length)];
          currentQuestionIndex = initialQuestions.indexOf(response);
        } else {
          askedQuestions.clear();
          response = initialQuestions[currentQuestionIndex];
        }
      }
      
      askedQuestions.add(response);
      lastResponse = response;
      addMessage(response, 'art-message');
      speak(response);
    }

    function generateNewArt() {
      askedQuestions.clear();
      currentQuestionIndex = Math.floor(Math.random() * initialQuestions.length);
      lastResponse = '';
      
      const artDisplay = document.getElementById('artDisplay');
      const colors = ['#ff9ac1', '#ffb6c1', '#ff80ab', '#ffa7d1', '#ff69b4'];
      const randomColor = colors[Math.floor(Math.random() * colors.length)];
      
      artDisplay.innerHTML = `
        <svg width="400" height="300" viewBox="0 0 400 300">
          <rect width="100%" height="100%" fill="#fff5f7"/>
          <circle cx="${Math.random() * 300 + 50}" cy="${Math.random() * 200 + 50}" 
                  r="${Math.random() * 40 + 20}" fill="${randomColor}" opacity="0.8">
            <animate attributeName="r" values="${Math.random() * 40 + 20};${Math.random() * 45 + 20};${Math.random() * 40 + 20}" 
                     dur="2s" repeatCount="indefinite"/>
          </circle>
          <path d="M${Math.random() * 200},${Math.random() * 150} Q${Math.random() * 300},${Math.random() * 200} ${Math.random() * 400},${Math.random() * 300}"
                stroke="${colors[Math.floor(Math.random() * colors.length)]}" 
                fill="none" 
                stroke-width="3">
            <animate attributeName="d" 
                     dur="3s"
                     repeatCount="indefinite"
                     values="M${Math.random() * 200},${Math.random() * 150} Q${Math.random() * 300},${Math.random() * 200} ${Math.random() * 400},${Math.random() * 300};
                             M${Math.random() * 200},${Math.random() * 150} Q${Math.random() * 300},${Math.random() * 200} ${Math.random() * 400},${Math.random() * 300}"/>
          </path>
        </svg>
      `;
      
      document.getElementById('chatArea').innerHTML = '';
      respondToMessage('');
    }

    function sendMessage() {
      const messageInput = document.getElementById('messageText');
      const text = messageInput.value.trim();
      
      if (text) {
        addMessage(text, 'user-message');
        messageInput.value = '';
        respondToMessage(text);
      }
    }

    function addMessage(text, className) {
      const chatArea = document.getElementById('chatArea');
      const messageDiv = document.createElement('div');
      messageDiv.className = `message ${className}`;
      messageDiv.textContent = text;
      chatArea.appendChild(messageDiv);
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function speak(text) {
      const utterance = new SpeechSynthesisUtterance(text);
      utterance.lang = 'ja-JP';
      synthesis.speak(utterance);
    }

    function toggleSpeech() {
      if (!recognition) {
        alert('ãŠä½¿ã„ã®ãƒ–ãƒ©ã‚¦ã‚¶ã¯éŸ³å£°èªè­˜ã«å¯¾å¿œã—ã¦ã„ã¾ã›ã‚“ã€‚');
        return;
      }

      if (isListening) {
        recognition.stop();
        isListening = false;
      } else {
        recognition.start();
        isListening = true;
      }
    }

    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
          const artDisplay = document.getElementById('artDisplay');
          artDisplay.innerHTML = `<img src="${e.target.result}" style="max-width: 100%; max-height: 400px; border-radius: 15px;">`;
          currentQuestionIndex = (currentQuestionIndex + 1) % initialQuestions.length;
          lastResponse = '';
          document.getElementById('chatArea').innerHTML = '';
          respondToMessage('');
        };
        reader.readAsDataURL(file);
      }
    }

    document.getElementById('messageText').addEventListener('keypress', function(e) {
      if (e.key === 'Enter') {
        sendMessage();
      }
    });

    const ws = new WebSocket('wss://example.com/ws');
    ws.onmessage = function(event) {
      const data = JSON.parse(event.data);
      if (data.type === 'participantCount') {
        document.getElementById('participantCount').textContent = data.count;
      } else if (data.type === 'message') {
        addMessage(data.text, data.className);
      }
    };
  </script>
</body></html>